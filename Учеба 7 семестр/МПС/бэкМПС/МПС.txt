
#define F_CPU 8000000


#include <avr/io.h>
#include <util/delay.h>
#include <stdlib.h>
#include <stdio.h>
#include <stdbool.h>
#include <time.h>
#include <avr/interrupt.h>

int i, cnt, flag;
// Создаем I, заданные по варианту
int i1 = 0, i2 = 0, i3 = 0, i4 = 0;
// создаем таймеры, заданные по вараинту
int t1 = 0, t2 = 0, t3 = 0;
// значения функций, создание лампочек
int o1 = 0, o2 = 0, o3 = 0, o4 = 0;

void initTimer() {
	// Разрешаем прерывание на INT0
	GICR |= (1<<INT0);

	TCCR0 |= 1;
	TCCR0 |= (1<<CS00);
	TCCR0 |= (1<<CS02);

	//устанавливаем бит разрешения прерывания 1ого счетчика по совпадению с OCR1A
	TIMSK |= (1<<OCIE1A);
	TCCR1B |= (1<<WGM12);
	TIMSK |= 0x01;
	OCR1AH = 0b01111010;
	OCR1AL = 0b00010010;
	// Устанавливаем делитель на 256, чтобы достичь 1Ггц
	TCCR1B |= (1<<CS12);

}
void setLeds(void) {
	o1 = (!o2 && !o3 && !o4) && t3;
	o2 = (i4 || o4 || i3) && t1;
	o3 = (i1 && i2) && t2;
	o4 = o3 && i3;
	PORTC = o1 ? PORTC | (1<<PORTC0) : PORTC & ~(1<<PORTC0);
	PORTC = o2 ? PORTC | (1<<PORTC1) : PORTC & ~(1<<PORTC1);
	PORTC = o3 ? PORTC | (1<<PORTC2) : PORTC & ~(1<<PORTC2);
	PORTC = o4 ? PORTC | (1<<PORTC3) : PORTC & ~(1<<PORTC3);

}
void seg(int digital)
{
	PORTC &= ~(1<<PORTC5);
	switch(digital) {
		case 1: PORTD = ~0b00000010; break;
		case 2:
		PORTD = ~0b01011011;
		PORTC ^= (1<<PORTC5);
		break;
		case 3: PORTD = ~0b01001011; break;
		case 4: PORTD = ~0b01100010; break;
		case 5: PORTD = ~0b01101001; break;
		case 6: PORTD = ~0b01111001; break;
		case 7: PORTD = ~0b00000011; break;
		case 8: PORTD = ~0b01111011; break;
		case 9: PORTD = ~0b01101011; break;
		case 0: PORTD = ~0b00111011; break;
	}
}


ISR (TIMER1_COMPA_vect)
{
	i++;
	if (i % 5 == 0) t1 = !t1;
	if (i % 7 == 0) t2 = !t2;
	if (i % 9 == 0) t3 = !t3;
	setLeds();
	if (flag == 0) seg(cnt % 10);
	else seg(0);

}

ISR(INT0_vect)
{
	cnt = 0;
	seg(0);
}

ISR(TIMER0_OVF_vect)
{
	if (flag == 1) seg(2);
}



int main (void)
{
	initTimer();
	// Устаналиваем PORTB на режим чтения
	DDRB = 0x00;
	PORTB = 0x00;
	// Устаналиваем PORTС на режим записи
	DDRC = 0xFF;
	PORTC = 0x00;
	// Устаналиваем PORTD на режим записи
	DDRD = 0b11111011;
	PORTD = ~0b00111011;


	i = 0;
	flag = 0;
	sei();
	i1 = PINB&(1<<0);
	i2 = PINB&(1<<1);
	i3 = PINB&(1<<2);
	i4 = PINB&(1<<3);
	setLeds();


	while(1) {
		int inp = PINB;
		i1 = inp & (1<<PB0);
		i2 = inp & (1<<PB1);
		i3 = inp & (1<<PB2);
		i4 = inp & (1<<PB3);

	}

}